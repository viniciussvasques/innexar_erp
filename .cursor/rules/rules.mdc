# ğŸ“‹ DEVELOPMENT RULES - Innexar ERP SaaS Multi-Tenant

## ğŸ¯ CONTEXTO DO PROJETO

### MissÃ£o
Criar um **ERP SaaS Multi-Tenant World-Class** usando Frappe Framework, competindo com lÃ­deres globais.

### Arquitetura Escolhida
- **Framework:** Frappe v15 (Python/MariaDB/Redis)
- **Multi-tenancy:** Site-based (1 database por tenant)
- **Deploy:** Docker Desktop (Windows) via frappe_docker oficial
- **Frontend:** Frappe UI + Custom Pages/Workspaces
- **Backend:** Python APIs + DocTypes
- **Billing:** Stripe (webhooks para autoprovision)
- **Market:** USA-first â†’ Brazil â†’ LATAM

### DecisÃµes TÃ©cnicas Importantes
1. âœ… **Frappe Framework** escolhido vs NestJS custom (apÃ³s anÃ¡lise comparativa)
2. âœ… **Docker Desktop** em vez de WSL2 (preferÃªncia do usuÃ¡rio)
3. âœ… **Site-based multi-tenancy** vs app-level (padrÃ£o Frappe, mais isolamento)
4. âœ… **Stripe webhooks** para autoprovision (signup no site institucional externo)
5. âœ… **APIs reais** sempre (zero mocks, dados reais desde o inÃ­cio)
6. âœ… **SeaNotes patterns** para factories e services (inspiraÃ§Ã£o de projeto real)

---

## ğŸ“š REGRAS DE DESENVOLVIMENTO FRAPPE

### 1. **Estrutura de Arquivos Frappe**
```
apps/innexar_core/
â”œâ”€â”€ innexar_core/
â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO - Python package)
â”‚   â”œâ”€â”€ hooks.py (configuraÃ§Ã£o app, formato PYTHON nÃ£o JSON!)
â”‚   â”œâ”€â”€ innexar_erp/
â”‚   â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO)
â”‚   â”‚   â”œâ”€â”€ doctype/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO)
â”‚   â”‚   â”‚   â”œâ”€â”€ tenant/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant.json (metadata)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant.py (controller, herda Document)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tenant_list.js (customizaÃ§Ã£o list view)
â”‚   â”‚   â”œâ”€â”€ page/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO)
â”‚   â”‚   â”‚   â”œâ”€â”€ tenant_dashboard/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant_dashboard.json (doctype: "Page")
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant_dashboard.py (backend APIs)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant_dashboard.js (frontend)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tenant_dashboard.html
â”‚   â”‚   â”œâ”€â”€ workspace/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO)
â”‚   â”‚   â”‚   â””â”€â”€ innexar_admin.json (doctype: "Workspace")
â”‚   â”œâ”€â”€ api.py (public APIs com @frappe.whitelist)
â”‚   â”œâ”€â”€ stripe_webhook.py (webhook handlers)
â”‚   â”œâ”€â”€ tenant_management/
â”‚   â”‚   â”œâ”€â”€ __init__.py (OBRIGATÃ“RIO)
â”‚   â”‚   â””â”€â”€ autoprovision.py
â”œâ”€â”€ setup.py
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

**âš ï¸ REGRA CRÃTICA:** TODO diretÃ³rio Python DEVE ter `__init__.py`, senÃ£o `ModuleNotFoundError`!

### 2. **hooks.py - Formato Correto**
```python
# hooks.py - SEMPRE Python, NUNCA JSON!
app_name = "innexar_core"
app_title = "Innexar Core"
app_publisher = "Innexar Inc"
app_description = "Multi-tenant SaaS foundation"
app_email = "dev@innexar.com"
app_license = "MIT"
app_version = "0.0.1"

required_apps = ["frappe"]

# Hooks opcionais (comentados servem como documentaÃ§Ã£o)
# scheduler_events = {
#     "daily": ["innexar_core.tasks.daily"]
# }
```

**âŒ NUNCA** usar formato JSON em hooks.py!

### 3. **DocType JSON - Campos ObrigatÃ³rios**
```json
{
  "doctype": "DocType",  // â† OBRIGATÃ“RIO
  "name": "Tenant",
  "module": "Innexar ERP",
  "custom": 0,
  "istable": 0,
  "editable_grid": 1,
  "fields": [...],
  "permissions": [...],
  "modified": "2025-11-13 15:00:00",
  "modified_by": "Administrator",
  "owner": "Administrator"
}
```

### 4. **Page/Workspace JSON - Campos ObrigatÃ³rios**
```json
{
  "doctype": "Page",  // â† OBRIGATÃ“RIO (ou "Workspace")
  "name": "tenant-dashboard",
  "title": "Tenant Dashboard",
  "module": "Innexar ERP",
  "standard": "Yes",
  "modified": "2025-11-13 15:00:00",
  "modified_by": "Administrator",
  "owner": "Administrator"
}
```

### 5. **Public APIs - Decorador Correto**
```python
import frappe

@frappe.whitelist(allow_guest=True)  # â† Para APIs pÃºblicas
def check_subdomain(subdomain):
    return {"available": True, "subdomain": subdomain}

@frappe.whitelist()  # â† Apenas autenticado
def get_tenant_stats():
    # Requer login
    return {"total": 10}
```

### 6. **DocType Controller - Estrutura PadrÃ£o**
```python
import frappe
from frappe.model.document import Document

class Tenant(Document):
    def validate(self):
        """ValidaÃ§Ãµes antes de salvar"""
        self.validate_subdomain()
    
    def before_insert(self):
        """Executado antes de inserir no DB"""
        pass
    
    def after_insert(self):
        """Executado apÃ³s inserir no DB"""
        pass
    
    def on_update(self):
        """Executado apÃ³s update"""
        pass
```

### 7. **Queries SQL - Usar Prepared Statements**
```python
# âœ… CORRETO - Seguro contra SQL injection
data = frappe.db.sql("""
    SELECT * FROM `tabTenant`
    WHERE status = %s AND plan = %s
""", (status, plan), as_dict=True)

# âŒ ERRADO - SQL injection vulnerability
data = frappe.db.sql(f"SELECT * FROM `tabTenant` WHERE status = '{status}'")
```

### 8. **Nomes de Tabelas - Frappe Convention**
```python
# Frappe adiciona prefixo "tab" automaticamente
DocType: Tenant       â†’ Tabela: `tabTenant`
DocType: Subscription â†’ Tabela: `tabSubscription`

# Usar sempre em queries:
frappe.db.sql("SELECT * FROM `tabTenant`")
```

---

## ğŸ”„ WORKFLOW DE DESENVOLVIMENTO

### Processo ObrigatÃ³rio para Qualquer MudanÃ§a

1. **SEMPRE verificar logs primeiro**
   ```bash
   docker logs frappe_docker_official-backend-1 --tail 100
   ```

2. **Fazer mudanÃ§as localmente** (Windows)
   ```
   Editar em: c:\innexar_erp\apps\innexar_core\...
   ```

3. **Copiar para container**
   ```bash
   docker cp arquivo.py frappe_docker_official-backend-1:/home/frappe/frappe-bench/apps/innexar_core/...
   ```

4. **Migrar se necessÃ¡rio** (DocTypes, Pages, Workspaces)
   ```bash
   docker exec frappe_docker_official-backend-1 bench --site innexar.local migrate
   ```

5. **Reiniciar backend** (mudanÃ§as em hooks.py, Python)
   ```bash
   docker restart frappe_docker_official-backend-1
   ```

6. **Verificar logs novamente**
   ```bash
   docker logs frappe_docker_official-backend-1 --tail 50
   ```

7. **Testar API/UI**
   ```bash
   # Via PowerShell
   Invoke-WebRequest -Uri "http://localhost:8080/api/method/..." -UseBasicParsing
   
   # Ou navegador
   http://localhost:8080/app/tenant-dashboard
   ```

### Checklist Antes de Commit

- [ ] Logs verificados (sem erros)
- [ ] APIs testadas (retornam 200 + JSON correto)
- [ ] UI testada (dashboard carrega, botÃµes funcionam)
- [ ] Migrations executadas
- [ ] `__init__.py` criados em todos os diretÃ³rios Python
- [ ] CÃ³digo documentado (docstrings)
- [ ] Contexto registrado em `CHANGELOG.md`

---

## ğŸ“ REGISTRO DE CONTEXTO

### Formato para CHANGELOG.md

```markdown
## [2025-11-13] - Dashboard Admin Criado

### Adicionado
- Workspace "Innexar Admin" com cards organizados
- Page "Tenant Dashboard" com KPIs, charts (Chart.js)
- APIs backend: get_dashboard_data, get_mrr_trend, get_plan_distribution
- List view customizations: tenant_list.js, subscription_list.js
- Script de dados de teste: create_test_data.py (9 tenants)

### Mudado
- hooks.py convertido de JSON para Python (formato correto Frappe)
- autoprovision.py: removido parÃ¢metro admin_email nÃ£o usado

### Corrigido
- ModuleNotFoundError: adicionados __init__.py em todos os diretÃ³rios
- DocType JSONs: adicionado campo "doctype" obrigatÃ³rio
- Page JSON: adicionados campos modified, modified_by, owner

### Logs Verificados
- âœ… Backend iniciou sem erros
- âœ… Gunicorn workers rodando (pid 7, 8)
- âœ… Dashboard updates: frappe, innexar_core

### APIs Testadas
- âœ… check_subdomain: retorna {"available": true}
- âœ… get_dashboard_data: retorna KPIs corretos

### Files Modified
- innexar_core/hooks.py
- innexar_core/innexar_erp/workspace/innexar_admin.json
- innexar_core/innexar_erp/page/tenant_dashboard/*
- innexar_core/innexar_erp/doctype/tenant/tenant_list.js
- innexar_core/innexar_erp/doctype/subscription/subscription_list.js
- innexar_core/create_test_data.py

### Containers Status
- frappe_docker_official-backend-1: Running âœ…
- frappe_docker_official-db-1: Running âœ…
- frappe_docker_official-redis-cache-1: Running âœ…

### Next Steps
- [ ] Configurar Stripe webhooks com secrets
- [ ] Testar fluxo signup â†’ webhook â†’ autoprovision
- [ ] Documentar integraÃ§Ã£o site institucional
```

---

## ğŸš¨ ERROS COMUNS E SOLUÃ‡Ã•ES

### 1. ModuleNotFoundError: No module named 'innexar_core'
**Causa:** Faltando `__init__.py` em algum diretÃ³rio
**SoluÃ§Ã£o:**
```bash
docker exec frappe_docker_official-backend-1 find /home/frappe/frappe-bench/apps/innexar_core -type d -exec touch {}/__init__.py \;
docker restart frappe_docker_official-backend-1
```

### 2. KeyError: 'doctype' durante migrate
**Causa:** JSON de DocType/Page/Workspace sem campo "doctype"
**SoluÃ§Ã£o:** Adicionar `"doctype": "Page"` ou `"doctype": "Workspace"`

### 3. hooks.py nÃ£o funciona
**Causa:** Formato JSON em vez de Python
**SoluÃ§Ã£o:** Converter para Python (ver seÃ§Ã£o "hooks.py - Formato Correto")

### 4. API retorna 404
**Causa:** Decorador `@frappe.whitelist()` faltando
**SoluÃ§Ã£o:** Adicionar decorador antes da funÃ§Ã£o

### 5. API retorna 403 (Forbidden)
**Causa:** API privada (sem allow_guest) acessada sem login
**SoluÃ§Ã£o:** Adicionar `allow_guest=True` ou fazer login primeiro

### 6. Charts nÃ£o renderizam
**Causa:** Chart.js nÃ£o carregado ou erro JS
**SoluÃ§Ã£o:** 
- Abrir DevTools (F12) â†’ Console
- Verificar erros JS
- Confirmar `new Chart()` funcionando

### 7. Workspace nÃ£o aparece
**Causa:** Migrate nÃ£o executado ou JSON invÃ¡lido
**SoluÃ§Ã£o:**
```bash
docker exec frappe_docker_official-backend-1 bench --site innexar.local migrate
docker restart frappe_docker_official-backend-1
```

---

## ğŸ” SEGURANÃ‡A

### Senhas e Secrets
- âŒ **NUNCA** commitar senhas reais em `.env`
- âœ… Usar `.env` apenas para desenvolvimento local
- âœ… ProduÃ§Ã£o: AWS Secrets Manager, Azure Key Vault, Docker Secrets
- âœ… `.env` estÃ¡ no `.gitignore`

### SQL Injection
- âŒ **NUNCA** usar f-strings em queries SQL
- âœ… Sempre usar prepared statements com `%s` placeholders

### XSS (Cross-Site Scripting)
- âœ… Frappe sanitiza automaticamente inputs
- âš ï¸ Cuidado com `frappe.render_template()` de dados nÃ£o confiÃ¡veis

### API Authentication
- âœ… Usar `@frappe.whitelist(allow_guest=True)` apenas para APIs pÃºblicas
- âœ… Validar inputs sempre (subdomain format, email, etc)

---

## ğŸ“Š MÃ‰TRICAS DE QUALIDADE

### Performance
- Queries SQL: max 100ms (usar `EXPLAIN` para otimizar)
- API response time: max 500ms
- Dashboard load: max 2s

### CÃ³digo
- Cobertura de testes: min 70% (futuro)
- Complexity: max 10 (cyclomatic)
- Docstrings: todas funÃ§Ãµes pÃºblicas

### UX
- Loading states: sempre mostrar spinners
- Erro handling: mensagens claras, nÃ£o tÃ©cnicas
- Responsive: suportar mobile (futuro)

---

## ğŸ¯ PRIORIDADES

### P0 (CrÃ­tico - Blocker)
1. Sistema funcional (Docker rodando, APIs respondendo)
2. Dados corretos (queries retornam valores reais)
3. Sem erros nos logs

### P1 (Alto - Must Have)
1. Stripe webhooks funcionando
2. Autoprovision criando tenants
3. Dashboard com dados reais

### P2 (MÃ©dio - Should Have)
1. Email service integrado
2. Testes automatizados
3. CI/CD pipeline

### P3 (Baixo - Nice to Have)
1. Charts avanÃ§ados (forecasting)
2. Mobile responsive
3. Dark mode

---

## ğŸ“š REFERÃŠNCIAS

### DocumentaÃ§Ã£o Oficial Frappe
- **Framework:** https://frappeframework.com/docs
- **DocTypes:** https://frappeframework.com/docs/user/en/basics/doctypes
- **APIs:** https://frappeframework.com/docs/user/en/api
- **Hooks:** https://frappeframework.com/docs/user/en/python-api/hooks

### Comandos Bench Ãšteis
```bash
# Criar DocType
bench --site innexar.local make-doctype "Tenant"

# Migrar
bench --site innexar.local migrate

# Console Python
bench --site innexar.local console

# Execute script
bench --site innexar.local execute module.function

# Reinstalar app
bench --site innexar.local reinstall-app innexar_core

# Clear cache
bench --site innexar.local clear-cache
```

### Patterns Importantes
- **Factory Pattern:** Services (email, payment, tax) via factories
- **Repository Pattern:** Data access via frappe.db.get_value, get_list
- **MVC:** DocType (Model), JS (Controller), HTML/JSON (View)

---

## âœ… ÃšLTIMA ATUALIZAÃ‡ÃƒO

**Data:** 2025-11-13 15:20 UTC
**Status:** Dashboard Admin criado e funcionando
**Containers:** 9/9 running
**APIs:** 4 endpoints ativos (check_subdomain, create_tenant, get_tenant_stats, list_tenants)
**Tenants de Teste:** 9 criados (6 Active, 2 Trial)
**MRR Atual:** $1,497/mÃªs
**PrÃ³ximo:** Configurar Stripe webhooks

---

**âš ï¸ REGRA DE OURO:** Sempre verificar logs antes e depois de qualquer mudanÃ§a!
---
alwaysApply: true
---
