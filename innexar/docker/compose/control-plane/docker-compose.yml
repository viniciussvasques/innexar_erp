x-app-volumes: &app_volumes
  - ../../../sites/common_site_config.json:/workspace/sites/common_site_config.json
  - ../../../sites/assets:/workspace/sites/assets
  - ../../../sites/innexar.local:/workspace/sites/innexar.local

x-app-environment: &app_environment
  SITE_NAME: innexar.local
  FRAPPE_ENV: production
  FRAPPE_REDIS_QUEUE: redis://redis-queue:6379/0
  FRAPPE_REDIS_CACHE: redis://redis-cache:6379/1

x-app-build: &app_build
  context: ../../..
  dockerfile: docker/images/frappe/Dockerfile

services:
  web:
    build: *app_build
    container_name: innexar-web-control
    restart: unless-stopped
    command:
      - gunicorn
      - -b
      - "0.0.0.0:8000"
      - frappe.app:application
      - --threads
      - "4"
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-cache
      - redis-queue
      - redis-socketio

  worker-default:
    build: *app_build
    container_name: innexar-worker-default-control
    restart: unless-stopped
    command:
      - python
      - -m
      - frappe.utils.bench_helper
      - frappe
      - --site
      - innexar.local
      - worker
      - --queue
      - default
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-queue

  scheduler:
    build: *app_build
    container_name: innexar-scheduler-control
    restart: unless-stopped
    command:
      - python
      - -m
      - frappe.utils.bench_helper
      - frappe
      - --site
      - innexar.local
      - schedule
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-queue

  socketio:
    build: *app_build
    container_name: innexar-socketio-control
    restart: unless-stopped
    working_dir: /workspace/frappe
    command:
      - node
      - realtime/index.js
    environment:
      <<: *app_environment
      SOCKETIO_PORT: "9000"
      NODE_ENV: production
    volumes: *app_volumes
    depends_on:
      - redis-socketio

  nginx:
    image: nginx:1.25-alpine
    container_name: innexar-nginx-control
    restart: unless-stopped
    ports:
      - "8000:80"
    volumes:
      - ../control-plane/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../../sites/assets:/var/www/html/assets:ro
      - ../../../sites/innexar.local:/var/www/html/sites/innexar.local:ro
      - ../../../frappe/frappe/public:/var/www/html/frappe:ro
      - ../../../erpnext/erpnext/public:/var/www/html/erpnext:ro
    depends_on:
      - web
      - socketio

  mariadb:
    image: mariadb:10.6
    container_name: control-plane-mariadb
    restart: unless-stopped
    command:
      - "mysqld"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_unicode_ci"
      - "--bind-address=0.0.0.0"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: innexar_control
    volumes:
      - db_data:/var/lib/mysql

  redis-cache:
    image: redis:alpine
    container_name: control-plane-redis-cache
    restart: unless-stopped

  redis-queue:
    image: redis:alpine
    container_name: control-plane-redis-queue
    restart: unless-stopped

  redis-socketio:
    image: redis:alpine
    container_name: control-plane-redis-socketio
    restart: unless-stopped

volumes:
  db_data:
