x-app-volumes: &app_volumes
  - ../../../sites/common_site_config.json:/workspace/sites/common_site_config.json
  - ../../../sites/assets:/workspace/sites/assets
  - ../../../sites/tenant1.local:/workspace/sites/tenant1.local

x-app-environment: &app_environment
  SITE_NAME: tenant1.local
  FRAPPE_ENV: production
  FRAPPE_REDIS_QUEUE: redis://redis-queue:6379/0
  FRAPPE_REDIS_CACHE: redis://redis-cache:6379/1

x-app-build: &app_build
  context: ../../..
  dockerfile: docker/images/frappe/Dockerfile

services:
  web:
    build: *app_build
    container_name: innexar-web-tenant1
    restart: unless-stopped
    command:
      - gunicorn
      - "-b"
      - "0.0.0.0:8000"
      - "-w"
      - "2"
      - "--threads"
      - "4"
      - "--timeout"
      - "120"
      - "frappe.app:application"
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-cache
      - redis-queue
      - redis-socketio

  worker-default:
    build: *app_build
    container_name: innexar-worker-default-tenant1
    restart: unless-stopped
    command:
      - python
      - -m
      - frappe.utils.bench_helper
      - frappe
      - --site
      - tenant1.local
      - worker
      - --queue
      - default
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-queue

  worker-short:
    build: *app_build
    container_name: innexar-worker-short-tenant1
    restart: unless-stopped
    command:
      - python
      - -m
      - frappe.utils.bench_helper
      - frappe
      - --site
      - tenant1.local
      - worker
      - --queue
      - short
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-queue

  worker-long:
    build: *app_build
    container_name: innexar-worker-long-tenant1
    restart: unless-stopped
    command:
      - python
      - -m
      - frappe.utils.bench_helper
      - frappe
      - --site
      - tenant1.local
      - worker
      - --queue
      - long
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-queue

  scheduler:
    build: *app_build
    container_name: innexar-scheduler-tenant1
    restart: unless-stopped
    command:
      - python
      - -m
      - frappe.utils.bench_helper
      - frappe
      - --site
      - tenant1.local
      - schedule
    environment:
      <<: *app_environment
    volumes: *app_volumes
    depends_on:
      - mariadb
      - redis-queue

  socketio:
    build: *app_build
    container_name: innexar-socketio-tenant1
    restart: unless-stopped
    working_dir: /workspace/frappe
    command:
      - node
      - realtime/index.js
    environment:
      <<: *app_environment
      SOCKETIO_PORT: "9000"
      NODE_ENV: production
    volumes: *app_volumes
    depends_on:
      - redis-socketio

  nginx:
    image: nginx:1.25-alpine
    container_name: innexar-nginx-tenant1
    restart: unless-stopped
    ports:
      - "8001:80"
    volumes:
      - ../tenant-1/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../../sites/assets:/var/www/html/assets:ro
      - ../../../sites/tenant1.local:/var/www/html/sites/tenant1.local:ro
    depends_on:
      - web
      - socketio

  mariadb:
    image: mariadb:10.6
    container_name: tenant-1-mariadb
    restart: unless-stopped
    command:
      - "mysqld"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_unicode_ci"
      - "--bind-address=0.0.0.0"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: tenant1
    volumes:
      - db_data:/var/lib/mysql

  redis-cache:
    image: redis:alpine
    container_name: tenant-1-redis-cache
    restart: unless-stopped

  redis-queue:
    image: redis:alpine
    container_name: tenant-1-redis-queue
    restart: unless-stopped

  redis-socketio:
    image: redis:alpine
    container_name: tenant-1-redis-socketio
    restart: unless-stopped

volumes:
  db_data:


